name: Deploy PROD HRIS APPS
on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: haris_apps
    environment: hris_apps
    env:
      WORKING_DIR: ${{ vars.WORKING_DIR_PROD }}
    steps:
      # === Before Script ===
      - name: Before script section
        run: |
          echo "Before script section"
          git checkout "$GITHUB_REF_NAME" || true
          git pull origin "$GITHUB_REF_NAME" || true
      
      # === Checkout Repository ===
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # === Deploy Script ===
      - name: Deploy application
        run: |
          if [ -d "$WORKING_DIR" ]; then
            echo "Processing sync source code..."
            
            # Sync directories
            rsync -avz --update app/ "$WORKING_DIR/app/"
            rsync -avz --update routes/ "$WORKING_DIR/routes/"
            rsync -avz --update config/ "$WORKING_DIR/config/"
            rsync -avz --update resources/ "$WORKING_DIR/resources/"
            rsync -avz --update bootstrap/ "$WORKING_DIR/bootstrap/"
            rsync -avz --update database/ "$WORKING_DIR/database/"
            rsync -avz --update public/assets/ "$WORKING_DIR/public/assets/" || true
            
            # Sync required root files
            [ -f composer.json ] && rsync -avz composer.json "$WORKING_DIR/"
            [ -f composer.lock ] && rsync -avz composer.lock "$WORKING_DIR/"
            [ -f package.json ] && rsync -avz package.json "$WORKING_DIR/"
            [ -f package-lock.json ] && rsync -avz package-lock.json "$WORKING_DIR/"
            [ -f artisan ] && rsync -avz artisan "$WORKING_DIR/"
            
            # Sync vite config (check both .js and .ts)
            [ -f vite.config.js ] && rsync -avz vite.config.js "$WORKING_DIR/"
            [ -f vite.config.ts ] && rsync -avz vite.config.ts "$WORKING_DIR/"
            
            # Sync other config files if exist
            [ -f tsconfig.json ] && rsync -avz tsconfig.json "$WORKING_DIR/"
            [ -f jsconfig.json ] && rsync -avz jsconfig.json "$WORKING_DIR/"
            [ -f tailwind.config.js ] && rsync -avz tailwind.config.js "$WORKING_DIR/"
            [ -f postcss.config.js ] && rsync -avz postcss.config.js "$WORKING_DIR/"
            
            echo "Processing build & deploy..."
            cd "$WORKING_DIR"
            
            # Composer operations
            echo "Installing PHP dependencies..."
            sudo composer install --no-dev --optimize-autoloader --no-interaction
            
            # NPM operations
            echo "Installing Node dependencies..."
            sudo npm ci || sudo npm install
            
            echo "Building assets..."
            sudo npm run build
            
            # Set permissions
            echo "Setting permissions..."
            sudo chown -R www-data:www-data storage bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache
            
            # Clear & cache Laravel
            echo "Optimizing Laravel..."
            sudo php artisan optimize:clear
            sudo php artisan config:cache
            sudo php artisan route:cache
            sudo php artisan view:cache
            
            # Restart queue workers
            echo "Restarting queue workers..."
            sudo supervisorctl restart laravel-queue:* || echo "No queue workers to restart"
            
            echo "✅ Deployment completed successfully!"
          else
            echo "❌ Directory tidak ada: $WORKING_DIR"
            exit 1
          fi
