name: Deploy PROD HRIS APPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: haris_apps
    environment: hris_apps
    env:
      WORKING_DIR: ${{ vars.WORKING_DIR_PROD }}

    steps:
      # =============================
      # Checkout Repository
      # =============================
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # =============================
      # Deploy Application
      # =============================
      - name: Deploy application
        run: |
          set -e

          # Validasi working directory
          if [ ! -d "$WORKING_DIR" ]; then
            echo "‚ùå WORKING_DIR tidak ditemukan: $WORKING_DIR"
            exit 1
          fi

          echo "üìÇ Masuk ke directory deploy..."
          cd "$WORKING_DIR"

          echo "üîê Ubah ownership sementara untuk deployment..."
          sudo chown -R $(whoami):$(whoami) .

          echo "üîÑ Sync source code..."
          rsync -avz --delete "${GITHUB_WORKSPACE}/app/" app/
          rsync -avz --delete "${GITHUB_WORKSPACE}/routes/" routes/
          rsync -avz --delete "${GITHUB_WORKSPACE}/config/" config/
          rsync -avz --delete "${GITHUB_WORKSPACE}/resources/" resources/
          rsync -avz --delete --exclude='cache/*' "${GITHUB_WORKSPACE}/bootstrap/" bootstrap/
          rsync -avz --delete "${GITHUB_WORKSPACE}/public/assets/" public/assets/
          rsync -avz "${GITHUB_WORKSPACE}/composer.json" "${GITHUB_WORKSPACE}/composer.lock" ./

          echo "üßπ Bersihkan cache dan vendor lama..."
          rm -rf vendor/
          rm -rf bootstrap/cache/*.php

          echo "üì¶ Install PHP dependencies (production only)..."
          composer install \
            --no-dev \
            --optimize-autoloader \
            --no-interaction \
            --prefer-dist \
            --classmap-authoritative

          echo "üé® Install & build frontend..."
          npm ci
          npm run build

          echo "üîê Set permission akhir (Laravel-safe)..."

          # Pastikan folder runtime ada
          sudo mkdir -p storage/logs bootstrap/cache
          sudo touch storage/logs/laravel.log || true

          # Ownership: hanya folder runtime yang perlu writable oleh www-data
          sudo chown -R www-data:www-data storage bootstrap/cache

          # Permission: directory 775, file 664 untuk runtime folder
          sudo find storage -type d -exec chmod 775 {} \;
          sudo find bootstrap/cache -type d -exec chmod 775 {} \;
          sudo find storage -type f -exec chmod 664 {} \;
          sudo find bootstrap/cache -type f -exec chmod 664 {} \;

          # Public read-only standar
          sudo chown -R www-data:www-data public
          sudo find public -type d -exec chmod 755 {} \;
          sudo find public -type f -exec chmod 644 {} \;

          echo "‚ö° Optimize Laravel..."
          php artisan optimize:clear
          php artisan optimize

          echo "üîÑ Restart queue worker..."
          sudo supervisorctl restart laravel-queue:*

          echo "‚úÖ Deploy selesai!"
