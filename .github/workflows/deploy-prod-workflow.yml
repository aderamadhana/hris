name: Deploy PROD HRIS APPS
on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: haris_apps
    environment: hris_apps
    env:
      WORKING_DIR: ${{ vars.WORKING_DIR_PROD }}
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # === DEBUG STEP: Check what files we have ===
      - name: Debug - List repository structure
        run: |
          echo "ðŸ“‹ Checking repository structure..."
          echo ""
          echo "=== Root files ==="
          ls -la | grep -E "(vite|package|composer|artisan|tsconfig)"
          echo ""
          echo "=== resources/js structure ==="
          find resources/js -type f -name "*.ts" -o -name "*.js" -o -name "*.vue" | head -20
          echo ""
          echo "=== Checking for routes files ==="
          find resources/js -name "*route*" -o -name "*password*" 2>/dev/null || echo "No route files found"
      
      - name: Deploy application
        run: |
          set -e
          
          if [ ! -d "$WORKING_DIR" ]; then
            echo "âŒ Directory not found: $WORKING_DIR"
            exit 1
          fi
          
          echo "ðŸš€ Starting deployment..."
          
          # Backup .env
          echo "ðŸ“¦ Backing up .env..."
          if [ -f "$WORKING_DIR/.env" ]; then
            sudo cp "$WORKING_DIR/.env" "/tmp/.env.backup"
          fi
          
          # Fix permissions
          echo "ðŸ”“ Setting permissions..."
          sudo chown -R $(whoami):$(whoami) "$WORKING_DIR" || true
          
          # Sync code with VERBOSE output
          echo "ðŸ“‚ Syncing source code..."
          rsync -avz --delete \
            --exclude='storage/' \
            --exclude='vendor/' \
            --exclude='node_modules/' \
            --exclude='.env' \
            --exclude='.git/' \
            --exclude='.github/' \
            ./ "$WORKING_DIR/"
          
          # Restore .env
          if [ -f "/tmp/.env.backup" ]; then
            sudo cp "/tmp/.env.backup" "$WORKING_DIR/.env"
          fi
          
          cd "$WORKING_DIR"
          
          # === DEBUG: Check what was synced ===
          echo "ðŸ” Verifying synced files..."
          echo "=== Checking resources/js/routes ==="
          ls -la resources/js/routes/ 2>/dev/null || echo "âš ï¸  resources/js/routes directory NOT FOUND"
          
          echo "=== Checking for password route file ==="
          find resources/js -name "*password*" 2>/dev/null || echo "âš ï¸  No password related files found"
          
          # Ensure storage exists
          mkdir -p storage/framework/{sessions,views,cache/data}
          mkdir -p storage/logs storage/app/public
          
          # Clean installations
          echo "ðŸ§¹ Cleaning old installations..."
          rm -rf vendor node_modules
          
          # Composer install
          echo "ðŸ“¥ Installing Composer dependencies..."
          composer clear-cache
          composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist
          
          # NPM install
          echo "ðŸ“¥ Installing NPM dependencies..."
          npm ci || npm install
          
          # === BEFORE BUILD: Final check ===
          echo "ðŸ” Final check before build..."
          echo "=== All TypeScript files in resources/js ==="
          find resources/js -name "*.ts" -o -name "*.vue" | sort
          
          # Build with better error output
          echo "ðŸ”¨ Building assets..."
          npm run build 2>&1 | tee /tmp/build.log || {
            echo "âŒ Build failed! Showing error context..."
            tail -50 /tmp/build.log
            exit 1
          }
          
          # Permissions
          echo "ðŸ”’ Setting permissions..."
          sudo chown -R www-data:www-data storage bootstrap/cache
          sudo chmod -R 775 storage bootstrap/cache
          
          # Optimize
          echo "âš¡ Optimizing..."
          php artisan optimize:clear
          php artisan optimize
          
          # Storage link
          php artisan storage:link || true
          
          # Restart queue
          sudo supervisorctl restart laravel-queue:* 2>/dev/null || true
          
          echo "âœ… Deployment completed!"
