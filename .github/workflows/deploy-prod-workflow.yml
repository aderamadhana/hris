name: Deploy PROD HRIS APPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: haris_apps
    environment: hris_apps
    env:
      WORKING_DIR: ${{ vars.WORKING_DIR_PROD }}
    
    steps:
      # =============================
      # Checkout Repository
      # =============================
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # =============================
      # Deploy Application
      # =============================
      - name: Deploy application
        run: |
          set -e
          
          # Validasi working directory
          if [ ! -d "$WORKING_DIR" ]; then
            echo "‚ùå WORKING_DIR tidak ditemukan: $WORKING_DIR"
            exit 1
          fi
          
          echo "üìÇ Masuk ke directory deploy..."
          cd "$WORKING_DIR"
          
          echo "üîÑ Sync source code..."
          rsync -avz --delete "${GITHUB_WORKSPACE}/app/" app/
          rsync -avz --delete "${GITHUB_WORKSPACE}/routes/" routes/
          rsync -avz --delete "${GITHUB_WORKSPACE}/config/" config/
          rsync -avz --delete "${GITHUB_WORKSPACE}/resources/" resources/
          rsync -avz --delete "${GITHUB_WORKSPACE}/bootstrap/" bootstrap/
          rsync -avz --delete "${GITHUB_WORKSPACE}/public/assets/" public/assets/
          rsync -avz "${GITHUB_WORKSPACE}/composer.json" "${GITHUB_WORKSPACE}/composer.lock" ./
          
          echo "üßπ Bersihkan vendor lama..."
          sudo rm -rf vendor/
          
          echo "üì¶ Install PHP dependencies (production only)..."
          composer install \
            --no-dev \
            --optimize-autoloader \
            --no-interaction \
            --prefer-dist \
            --classmap-authoritative
          
          echo "üé® Install & build frontend..."
          npm ci
          npm run build
          
          echo "üîê Set permission..."
          sudo chown -R www-data:www-data storage bootstrap/cache
          sudo chmod -R 775 storage bootstrap/cache
          
          echo "‚ö° Optimize Laravel..."
          php artisan optimize:clear
          php artisan optimize
          
          echo "üîÑ Restart queue worker..."
          sudo supervisorctl restart laravel-queue:*
          
          echo "‚úÖ Deploy selesai!"
