name: Deploy PROD HRIS APPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: haris_apps
    environment: hris_apps

    env:
      WORKING_DIR: ${{ vars.WORKING_DIR_PROD }}

    steps:
      # =============================
      # Checkout Repository
      # =============================
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # =============================
      # Deploy Application
      # =============================
      - name: Deploy application
        run: |
          set -e

          if [ ! -d "$WORKING_DIR" ]; then
            echo "WORKING_DIR tidak ditemukan: $WORKING_DIR"
            exit 1
          fi

          echo "Masuk ke directory deploy..."
          cd "$WORKING_DIR"

          echo "Sync source code..."
          rsync -avz app/ app/
          rsync -avz routes/ routes/
          rsync -avz config/ config/
          rsync -avz resources/ resources/
          rsync -avz bootstrap/ bootstrap/
          rsync -avz public/assets/ public/assets/
          rsync -avz composer.json composer.lock ./

          echo "Bersihkan vendor lama..."
          rm -rf vendor/

          echo "Install PHP dependencies (production only)..."
          composer install \
            --no-dev \
            --optimize-autoloader \
            --no-interaction \
            --prefer-dist

          echo "Install & build frontend..."
          npm ci
          npm run build

          echo "Set permission..."
          chown -R www-data:www-data storage bootstrap/cache

          echo "Optimize Laravel..."
          php artisan optimize:clear
          php artisan optimize

          echo "Restart queue worker..."
          supervisorctl restart laravel-queue:*

          echo "Deploy selesai."
