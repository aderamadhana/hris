name: Deploy PROD HRIS APPS
on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: haris_apps
    environment: hris_apps
    env:
      WORKING_DIR: ${{ vars.WORKING_DIR_PROD }}
    steps:
      # === Checkout Repository ===
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # === Deploy Script ===
      - name: Deploy application
        run: |
          if [ -d "$WORKING_DIR" ]; then
            echo "üöÄ Starting deployment..."
            
            # Backup .env file
            echo "üì¶ Backing up .env file..."
            if [ -f "$WORKING_DIR/.env" ]; then
              sudo cp "$WORKING_DIR/.env" "/tmp/.env.backup"
            fi
            
            # Fix permissions before sync
            echo "üîì Preparing directories..."
            sudo chown -R $(whoami):$(whoami) "$WORKING_DIR" 2>/dev/null || true
            
            # Full sync - EXCLUDE entire storage directory
            echo "üìÇ Syncing source code..."
            rsync -avz --delete \
              --exclude='storage/' \
              --exclude='vendor/' \
              --exclude='node_modules/' \
              --exclude='.env' \
              --exclude='.git/' \
              --exclude='.github/' \
              --exclude='tests/' \
              --exclude='phpunit.xml' \
              ./ "$WORKING_DIR/"
            
            # Sync only storage structure (gitignore files) if needed
            echo "üìÅ Ensuring storage structure..."
            if [ ! -d "$WORKING_DIR/storage" ]; then
              rsync -avz storage/ "$WORKING_DIR/storage/"
            fi
            
            # Restore .env
            echo "üîê Restoring .env file..."
            if [ -f "/tmp/.env.backup" ]; then
              sudo cp "/tmp/.env.backup" "$WORKING_DIR/.env"
            fi
            
            # Navigate to working directory
            cd "$WORKING_DIR"
            
            # Create storage directories if they don't exist
            echo "üìÅ Creating storage directories..."
            mkdir -p storage/framework/{sessions,views,cache}
            mkdir -p storage/logs
            mkdir -p storage/app/public
            
            # Install PHP dependencies
            echo "üì• Installing Composer dependencies..."
            composer install --no-dev --optimize-autoloader --no-interaction
            
            # Install Node dependencies
            echo "üì• Installing NPM dependencies..."
            npm ci
            
            # Build assets
            echo "üî® Building TypeScript & Vue assets..."
            npm run build
            
            # Set proper permissions for web server
            echo "üîí Setting final permissions..."
            sudo chown -R www-data:www-data storage bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache
            
            # Laravel optimization
            echo "‚ö° Optimizing Laravel..."
            php artisan optimize:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            # Create storage link if needed
            php artisan storage:link 2>/dev/null || true
            
            # Restart services
            echo "üîÑ Restarting services..."
            sudo supervisorctl restart laravel-queue:* 2>/dev/null || echo "No queue workers configured"
            
            echo "‚úÖ Deployment completed successfully!"
          else
            echo "‚ùå Directory not found: $WORKING_DIR"
            exit 1
          fi
