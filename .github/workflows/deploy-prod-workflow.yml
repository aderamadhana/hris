name: Deploy PROD HRIS APPS
on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: haris_apps
    environment: hris_apps
    env:
      WORKING_DIR: ${{ vars.WORKING_DIR_PROD }}
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true
      
      - name: Deploy application
        run: |
          set -e
          
          if [ ! -d "$WORKING_DIR" ]; then
            echo "âŒ Directory not found: $WORKING_DIR"
            exit 1
          fi
          
          echo "ðŸš€ Starting deployment..."
          
          # Backup .env
          echo "ðŸ“¦ Backing up .env..."
          if [ -f "$WORKING_DIR/.env" ]; then
            sudo cp "$WORKING_DIR/.env" "/tmp/.env.backup"
          fi
          
          # Fix permissions
          echo "ðŸ”“ Setting permissions..."
          sudo chown -R $(whoami):$(whoami) "$WORKING_DIR" || true
          
          # Sync code - exclude unused Inertia starter files
          echo "ðŸ“‚ Syncing source code..."
          rsync -avz --delete \
            --exclude='storage/' \
            --exclude='vendor/' \
            --exclude='node_modules/' \
            --exclude='.env' \
            --exclude='.git/' \
            --exclude='.github/' \
            --exclude='tests/' \
            --exclude='phpunit.xml' \
            --exclude='resources/js/pages/auth/ResetPassword.vue' \
            --exclude='resources/js/pages/auth/ForgotPassword.vue' \
            --exclude='resources/js/pages/auth/VerifyEmail.vue' \
            --exclude='resources/js/pages/auth/ConfirmPassword.vue' \
            ./ "$WORKING_DIR/"
          
          # Restore .env
          if [ -f "/tmp/.env.backup" ]; then
            sudo cp "/tmp/.env.backup" "$WORKING_DIR/.env"
          fi
          
          cd "$WORKING_DIR"
          
          # Clean up any remaining unused files (safety measure)
          echo "ðŸ§¹ Removing unused Inertia starter files..."
          rm -f resources/js/pages/auth/ResetPassword.vue
          rm -f resources/js/pages/auth/ForgotPassword.vue
          rm -f resources/js/pages/auth/VerifyEmail.vue
          rm -f resources/js/pages/auth/ConfirmPassword.vue
          
          # Ensure storage structure exists
          echo "ðŸ“ Ensuring storage directories..."
          mkdir -p storage/framework/{sessions,views,cache/data}
          mkdir -p storage/logs
          mkdir -p storage/app/public
          
          # Clean old installations
          echo "ðŸ§¹ Cleaning old installations..."
          rm -rf vendor node_modules
          
          # Composer install
          echo "ðŸ“¥ Installing Composer dependencies..."
          composer clear-cache
          composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist
          
          # NPM install
          echo "ðŸ“¥ Installing NPM dependencies..."
          npm ci || npm install
          
          # Build assets
          echo "ðŸ”¨ Building TypeScript & Vue assets..."
          npm run build
          
          # Set proper permissions
          echo "ðŸ”’ Setting permissions..."
          sudo chown -R www-data:www-data storage bootstrap/cache
          sudo chmod -R 775 storage bootstrap/cache
          
          # Laravel optimization
          echo "âš¡ Optimizing Laravel..."
          php artisan optimize:clear
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          
          # Create storage link
          echo "ðŸ”— Creating storage link..."
          php artisan storage:link || true
          
          # Restart queue workers
          echo "ðŸ”„ Restarting queue workers..."
          sudo supervisorctl restart laravel-queue:* 2>/dev/null || echo "No queue workers configured"
          
          echo "âœ… Deployment completed successfully!"
