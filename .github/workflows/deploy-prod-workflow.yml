name: Deploy PROD HRIS APPS
on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: haris_apps
    environment: hris_apps
    env:
      WORKING_DIR: ${{ vars.WORKING_DIR_PROD }}
    steps:
      # === Checkout Repository ===
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # === Deploy Script ===
      - name: Deploy application
        run: |
          if [ -d "$WORKING_DIR" ]; then
            echo "üöÄ Starting deployment..."
            
            # Backup .env file
            echo "üì¶ Backing up .env file..."
            if [ -f "$WORKING_DIR/.env" ]; then
              cp "$WORKING_DIR/.env" "/tmp/.env.backup"
            fi
            
            # Full sync with proper exclusions
            echo "üìÇ Syncing source code..."
            rsync -avz --delete \
              --exclude='storage/app/public/*' \
              --exclude='storage/logs/*' \
              --exclude='storage/framework/cache/data/*' \
              --exclude='storage/framework/sessions/*' \
              --exclude='storage/framework/views/*' \
              --exclude='vendor/' \
              --exclude='node_modules/' \
              --exclude='.env' \
              --exclude='.git/' \
              --exclude='.github/' \
              --exclude='tests/' \
              --exclude='phpunit.xml' \
              ./ "$WORKING_DIR/"
            
            # Restore .env
            echo "üîê Restoring .env file..."
            if [ -f "/tmp/.env.backup" ]; then
              cp "/tmp/.env.backup" "$WORKING_DIR/.env"
            fi
            
            # Navigate to working directory
            cd "$WORKING_DIR"
            
            # Install PHP dependencies
            echo "üì• Installing Composer dependencies..."
            composer install --no-dev --optimize-autoloader --no-interaction
            
            # Install Node dependencies
            echo "üì• Installing NPM dependencies..."
            npm ci
            
            # Build assets
            echo "üî® Building TypeScript & Vue assets..."
            npm run build
            
            # Set permissions
            echo "üîí Setting permissions..."
            chown -R www-data:www-data storage bootstrap/cache
            chmod -R 775 storage bootstrap/cache
            
            # Laravel optimization
            echo "‚ö° Optimizing Laravel..."
            php artisan optimize:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            # Restart services
            echo "üîÑ Restarting services..."
            supervisorctl restart laravel-queue:* 2>/dev/null || echo "No queue workers configured"
            
            echo "‚úÖ Deployment completed successfully!"
          else
            echo "‚ùå Directory not found: $WORKING_DIR"
            exit 1
          fi
