name: Deploy PROD HRIS APPS
on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: haris_apps
    environment: hris_apps
    env:
      WORKING_DIR: ${{ vars.WORKING_DIR_PROD }}
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Deploy application
        run: |
          set -e  # Exit on error
          
          if [ ! -d "$WORKING_DIR" ]; then
            echo "âŒ Directory not found: $WORKING_DIR"
            exit 1
          fi
          
          echo "ðŸš€ Starting deployment..."
          
          # Backup .env
          echo "ðŸ“¦ Backing up .env..."
          if [ -f "$WORKING_DIR/.env" ]; then
            sudo cp "$WORKING_DIR/.env" "/tmp/.env.backup"
          fi
          
          # Fix permissions
          echo "ðŸ”“ Setting permissions..."
          sudo chown -R $(whoami):$(whoami) "$WORKING_DIR" || true
          
          # Sync code
          echo "ðŸ“‚ Syncing source code..."
          rsync -avz --delete \
            --exclude='storage/' \
            --exclude='vendor/' \
            --exclude='node_modules/' \
            --exclude='.env' \
            --exclude='.git/' \
            --exclude='.github/' \
            ./ "$WORKING_DIR/"
          
          # Restore .env
          if [ -f "/tmp/.env.backup" ]; then
            sudo cp "/tmp/.env.backup" "$WORKING_DIR/.env"
          fi
          
          cd "$WORKING_DIR"
          
          # Ensure storage exists
          mkdir -p storage/framework/{sessions,views,cache/data}
          mkdir -p storage/logs storage/app/public
          
          # Clean installations
          echo "ðŸ§¹ Cleaning old installations..."
          rm -rf vendor node_modules
          
          # Composer install with retry
          echo "ðŸ“¥ Installing Composer dependencies..."
          composer clear-cache
          
          # Try install, if fails try with composer.lock removal
          if ! composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist; then
            echo "âš ï¸  First install failed, trying without lock file..."
            rm -f composer.lock
            composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist
          fi
          
          # NPM install
          echo "ðŸ“¥ Installing NPM dependencies..."
          npm ci || npm install
          
          # Build
          echo "ðŸ”¨ Building assets..."
          npm run build
          
          # Permissions
          echo "ðŸ”’ Setting permissions..."
          sudo chown -R www-data:www-data storage bootstrap/cache
          sudo chmod -R 775 storage bootstrap/cache
          
          # Optimize
          echo "âš¡ Optimizing..."
          php artisan optimize:clear
          php artisan optimize
          
          # Storage link
          php artisan storage:link || true
          
          # Restart queue
          sudo supervisorctl restart laravel-queue:* 2>/dev/null || true
          
          echo "âœ… Deployment completed!"
