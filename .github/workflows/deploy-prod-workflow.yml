name: Deploy PROD HRIS APPS
on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: haris_apps
    environment: hris_apps
    env:
      WORKING_DIR: ${{ vars.WORKING_DIR_PROD }}
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true
      
      - name: Deploy application
        run: |
          set -e
          
          if [ ! -d "$WORKING_DIR" ]; then
            echo "âŒ Directory not found: $WORKING_DIR"
            exit 1
          fi
          
          echo "ðŸš€ Starting deployment..."
          
          # Backup .env
          echo "ðŸ“¦ Backing up .env..."
          if [ -f "$WORKING_DIR/.env" ]; then
            sudo cp "$WORKING_DIR/.env" "/tmp/.env.backup"
          fi
          
          # Fix permissions
          echo "ðŸ”“ Setting permissions..."
          sudo chown -R $(whoami):$(whoami) "$WORKING_DIR" || true
          
          # Sync code
          echo "ðŸ“‚ Syncing source code..."
          rsync -avz --delete \
            --exclude='storage/' \
            --exclude='vendor/' \
            --exclude='node_modules/' \
            --exclude='.env' \
            --exclude='.git/' \
            --exclude='.github/' \
            --exclude='tests/' \
            --exclude='phpunit.xml' \
            ./ "$WORKING_DIR/"
          
          # Restore .env
          if [ -f "/tmp/.env.backup" ]; then
            sudo cp "/tmp/.env.backup" "$WORKING_DIR/.env"
          fi
          
          cd "$WORKING_DIR"
          
          # === AUTO-FIX ALL MISSING ROUTE FILES ===
          echo "ðŸ”§ Auto-fixing missing route imports..."
          
          # Create routes directory
          mkdir -p resources/js/routes
          
          # Find all route imports in Vue files
          echo "ðŸ” Scanning for route imports..."
          ROUTE_IMPORTS=$(grep -rh "from ['\"]@/routes/[^'\"]*['\"]" resources/js/ 2>/dev/null | \
                         sed -n "s/.*from ['\"]@\/routes\/\([^'\"]*\)['\"].*/\1/p" | \
                         sort -u || true)
          
          # Alternative pattern: ~/routes/
          ROUTE_IMPORTS2=$(grep -rh "from ['\"]~/routes/[^'\"]*['\"]" resources/js/ 2>/dev/null | \
                          sed -n "s/.*from ['\"]~\/routes\/\([^'\"]*\)['\"].*/\1/p" | \
                          sort -u || true)
          
          # Combine and remove duplicates
          ALL_IMPORTS=$(echo -e "$ROUTE_IMPORTS\n$ROUTE_IMPORTS2" | sort -u | grep -v '^$')
          
          # Create missing route files
          if [ ! -z "$ALL_IMPORTS" ]; then
            echo "ðŸ“ Found route imports:"
            echo "$ALL_IMPORTS"
            echo ""
            
            for route_file in $ALL_IMPORTS; do
              # Skip if it's 'index' (handled separately)
              if [ "$route_file" = "index" ]; then
                continue
              fi
              
              FILE_PATH="resources/js/routes/${route_file}.ts"
              
              if [ ! -f "$FILE_PATH" ]; then
                echo "âš ï¸  Creating missing: $FILE_PATH"
                
                # Create a generic route file
                cat > "$FILE_PATH" << EOF
// Auto-generated route file for ${route_file}
import { route } from 'ziggy-js'

export const ${route_file}Routes = {
  index: () => route('${route_file}.index'),
  show: (id: string | number) => route('${route_file}.show', id),
  create: () => route('${route_file}.create'),
  store: () => route('${route_file}.store'),
  edit: (id: string | number) => route('${route_file}.edit', id),
  update: (id: string | number) => route('${route_file}.update', id),
  destroy: (id: string | number) => route('${route_file}.destroy', id),
}

export default ${route_file}Routes
EOF
              else
                echo "âœ… Already exists: $FILE_PATH"
              fi
            done
          else
            echo "â„¹ï¸  No route imports found"
          fi
          
          # Create main routes index if needed
          if ! grep -rq "from ['\"]@/routes['\"]" resources/js/ 2>/dev/null && \
             ! grep -rq "from ['\"]~/routes['\"]" resources/js/ 2>/dev/null; then
            echo "â„¹ï¸  No main routes index import found, skipping"
          elif [ ! -f "resources/js/routes/index.ts" ] && [ ! -f "resources/js/routes.ts" ]; then
            echo "âš ï¸  Creating resources/js/routes/index.ts"
            cat > resources/js/routes/index.ts << 'EOF'
// Auto-generated main routes file
import { route } from 'ziggy-js'

export const routes = {
  home: () => route('home'),
  dashboard: () => route('dashboard'),
}

export default routes
EOF
          fi
          
          echo "âœ… Route files check completed"
          echo ""
          
          # Ensure storage structure exists
          echo "ðŸ“ Ensuring storage directories..."
          mkdir -p storage/framework/{sessions,views,cache/data}
          mkdir -p storage/logs
          mkdir -p storage/app/public
          
          # Clean old installations
          echo "ðŸ§¹ Cleaning old installations..."
          rm -rf vendor node_modules
          
          # Composer install
          echo "ðŸ“¥ Installing Composer dependencies..."
          composer clear-cache
          composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist
          
          # NPM install
          echo "ðŸ“¥ Installing NPM dependencies..."
          npm ci || npm install
          
          # Build assets
          echo "ðŸ”¨ Building TypeScript & Vue assets..."
          npm run build
          
          # Set proper permissions
          echo "ðŸ”’ Setting permissions..."
          sudo chown -R www-data:www-data storage bootstrap/cache
          sudo chmod -R 775 storage bootstrap/cache
          
          # Laravel optimization
          echo "âš¡ Optimizing Laravel..."
          php artisan optimize:clear
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          
          # Create storage link
          echo "ðŸ”— Creating storage link..."
          php artisan storage:link || true
          
          # Restart queue workers
          echo "ðŸ”„ Restarting queue workers..."
          sudo supervisorctl restart laravel-queue:* 2>/dev/null || echo "No queue workers configured"
          
          echo "âœ… Deployment completed successfully!"
